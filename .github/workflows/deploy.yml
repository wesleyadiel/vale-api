name: Deploy Prod

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: üöÄ Deploy App
    runs-on: ubuntu-latest

    steps:
      - name: ‚è¨ Checkout c√≥digo
        uses: actions/checkout@v3

      - name: ‚òï Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: üõ†Ô∏è Build com Maven
        run: mvn clean package -DskipTests

      - name: üõ†Ô∏è Criar script de start remoto
        run: |
          cat << 'EOF' > remote-restart.sh
          #!/bin/bash

          echo "üö® Verificando processo com o JAR ${{ secrets.JAR_NAME }}"
          PID=$(pgrep -f ${{ secrets.JAR_NAME }})
          if [ -n "$PID" ]; then
            echo "üî™ Matando processo $PID..."
            kill -9 $PID
            echo "‚úÖ Processo finalizado."
          else
            echo "‚ÑπÔ∏è Nenhum processo rodando."
          fi

          echo "‚åõ Aguardando..."
          sleep 3

          echo "üìÇ Acessando pasta ${{ secrets.REMOTE_APP_PATH }}/target"
          cd ${{ secrets.REMOTE_APP_PATH }}/target

          echo "üìç Diret√≥rio atual: $(pwd)"
          echo "üìÑ Conte√∫do:"
          ls -l

          echo "üöÄ Iniciando app com nohup..."
          nohup java -jar ${{ secrets.JAR_NAME }} > nohup.out 2>&1 &

          echo "‚úÖ App iniciado!"
          EOF

      - name: üì§ Copiar arquivos (JAR + Script) via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_KEY }}
          source: |
            target/${{ secrets.JAR_NAME }}
            remote-restart.sh
          target: ${{ secrets.REMOTE_APP_PATH }}

      - name: üöÄ Executar script de restart remoto via SSH
        run: |
          ssh -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} \
              "chmod +x ${{ secrets.REMOTE_APP_PATH }}/remote-restart.sh && ${{ secrets.REMOTE_APP_PATH }}/remote-restart.sh"
        env:
          # Copia a chave privada do secret para ser usada pelo SSH
          SSH_PRIVATE_KEY: ${{ secrets.LIGHTSAIL_KEY }}
        shell: bash
